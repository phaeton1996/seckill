<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>商品详情页面</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- 本页css -->
    <link rel="stylesheet" href="css/baguetteBox.min.css"/>
    <link rel="stylesheet" href="css/goodsdetail.css"/>

    <!-- 搜索框样式 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="css/style.css"/>

    <!-- 后期需要提取css -->
    <style type="text/css">
        html, body {
            width: 100%;
            height: 100%;
        }

        /*非常重要的样式让背景图片100%适应整个屏幕*/

        .my-navbar {
            padding: 10px 15%;
            transition: background 0.5s ease-in-out, padding 0.5s ease-in-out;
            background-color: #000;
        }

        .my-navbar a {
            background: transparent !important;
            color: #fff !important
        }

        .my-navbar a:hover {
            color: #45bcf9 !important;
            background: transparent;
            outline: 0
        }

        .my-navbar a {
            transition: color 0.5s ease-in-out;
        }

        /*-webkit-transition ;-moz-transition*/
        .top-nav {
            padding: 0px 15%;
            background: #000;
        }

    </style>
</head>
<body>

<!-- html start -->
<!-- nav导航栏 -->
<nav class="navbar navbar-fixed-top my-navbar" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target="#example-navbar-collapse">
                <span class="sr-only">切换导航</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">多拼拼</a>
        </div>
        <div class="collapse navbar-collapse" id="example-navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">秒杀新品</a></li>
                <li>
                    <a href="#">加入我们</a>
                </li>
            </ul>

            <ul class="nav navbar-nav navbar-right" id="nav-right">

            </ul>

            <ul class="nav navbar-nav navbar-right">
                <!-- 搜索框 -->
                <li>
                    <div class="search d7" style="padding-top: 10px">
                        <form>
                            <input type="text" style="color:#F5F5F5;" placeholder="Search..."/>
                            <button type="submit"></button>
                        </form>
                    </div>
                </li>
            </ul>


        </div>
    </div>
</nav>
<!-- 登陆的模态框 -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">登陆页面</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" style="width: 100%">

                    <div class="form-group">
                        <label class="col-sm-3 control-label">账号</label>
                        <div class="col-sm-6">
                            <input type="text" name="account" class="form-control" id="login_userName_input"
                                   placeholder="请输入你的用户名" value="phaeton"/>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">密码</label>
                        <div class="col-sm-6">
                            <input type="password" name="password" class="form-control" id="login_password_input"
                                   placeholder="请输入你的密码" value="970108"/>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="user_login_btn">登陆</button>
            </div>
        </div>
    </div>
</div>
<!-- 注册的模态框 -->
<div class="modal fade" id="regModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">注册页面</h4>
            </div>
            <div class="modal-body">
                <!-- 注册表单 -->
                <form class="form-horizontal" style="width: 100%">
                    <div class="form-group">
                        <!-- 用户名 -->
                        <label class="col-sm-3 control-label">用户名</label>
                        <div class="col-sm-6">
                            <input type="text" name="userName" class="form-control" id="reg_userName_input"
                                   placeholder="请输入你的用户名"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <!-- 账号 -->
                        <label class="col-sm-3 control-label">账号</label>
                        <div class="col-sm-6">
                            <input type="text" name="userName" class="form-control" id=""
                                   placeholder="请输入你的账号"/>
                            <span class="help-block"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <!-- 密码 -->
                        <label class="col-sm-3 control-label">密码</label>
                        <div class="col-sm-6">
                            <input type="password" name="password" class="form-control" id="reg_password_input"
                                   placeholder="请输入你的密码"/>
                            <span class="help-block"></span>
                        </div>
                    </div>

                    <!-- 验证码 -->
                    <div class="form-group">
                        <label class="col-sm-3 control-label">验证码</label>
                        <div class="col-sm-6">
                            <input type="text" name="val" class="form-control" id="reg_val_input"
                                   placeholder="请输入下图的验证码"/>
                            <span class="help-block"></span>
                            <img id="captcha_img" src="119.29.138.243/sys/reg/Kaptcha"
                                 onclick="changeVerifyCode(this)"/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="user_reg_close">关闭</button>
                <button type="button" class="btn btn-primary" id="user_reg_btn">注册</button>
            </div>
        </div>
    </div>
</div>
<!-- 秒杀信息的模态框 -->
<div class="modal fade" id="InformationModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document" style="width: 40%">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">订单信息确认</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" style="width: 100%">

                    <div class="form-group">
                        <label class="col-sm-3 control-label">商品名</label>
                        <div class="col-sm-6">
                            <h5 id="goodsName"></h5>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">数量</label>
                        <div class="col-sm-6">
                            <h5>1份</h5>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label">收货地址</label>
                        <div class="col-sm-6" id="addrHolder">

                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="seckill" onclick="doSeckill();">提交</button>
            </div>
        </div>
    </div>
</div>
<!-- nav导航栏 -->

<!-- 主页面 -->
<div class="container" style="margin-top: 100px;">
    <div class="row clearfix">
        <h1 class="page-big">商品详情</h1>

        <div class="item list-group-item">
            <!-- 上面部分 -->
            <div class="thumbnail">
                <div class="img-size">
                    <img class="group list-group-image" id="img"
                         alt=""/>
                </div>
                <div class="caption">
                    <h3 class="goodsname" id="name"></h3>
                    <p class="desc" id="desc"></p>
                    <p class="xianjia" id="seckillPrice"></p>
                    <p class="yuanjia" id="price"></p>
                    <p class="stock" id="stock"></p>
                </div>
            </div>
            <div id="statusHolder">


            </div>

        </div>

    </div>
</div>

<!-- html end -->

<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
<!-- layer -->
<script src="layer/layer.js"></script>
<!-- 加载登陆注册相关的自定义脚本 -->
<script src="js/LoginReg.js"></script>
<script src="js/common.js"></script>


<script>
    // nav导航栏下拉变化结果
    $(window).scroll(function () {
        if ($(".navbar").offset().top > 50) {
            $(".navbar-fixed-top").addClass("top-nav");
        } else {
            $(".navbar-fixed-top").removeClass("top-nav");
        }
    });


    // 以下是与商品数据相关的js脚本
    var goodsId;
    var timeLag = 3600 * 8 * 1000;
    var has = false;

    $(function () {
        goodsId = g_getQueryString("id");
        getGoodsDeatil(goodsId);
    });

    function getGoodsDeatil(goodsId) {
        $.ajax({
            url: 'goods/detail',
            data: {
                'goodsId': goodsId
            },
            success: function (res) {
                if (res.code == 201) {
                    render(res.data);
                    renderStatus(res.data.startTime, res.data.endTime);
                } else {
                    alert(res.msg);
                }
            }
        })
    }

    function render(data) {
        $('#name').text(data.name);
        $('#desc').text(data.descr);
        $('#seckillPrice').text('抢购价：¥' + data.seckillPrice);
        $('#price').text('原  价：¥' + data.price);
        $('#stock').text('存  库：' + data.stocks + '件');
        $('#img').attr('src', data.imgUrl);
    }

    // Date转换成Json之后是 时间戳
    function renderStatus(startTime, endTime) {
        var now = new Date().getTime();
        var statusHolder = $('#statusHolder');
        if (now < startTime) {
            // 未开始
            countdown(statusHolder, startTime);
        } else if (now > startTime && startTime < endTime) {
            // 正在抢购
            renderSeckilling(statusHolder);
        } else {
            // 已经结束
            renderEnd(statusHolder);
        }
    }

    // 倒计时功能，如果到了开始时间，则开放按钮
    function countdown(ele, startTime) {
        var now = new Date().getTime();
        var remain = startTime - now;
        if (remain <= 0) {
            renderSeckilling(ele);
        } else {
            // jQuery 等待函数
            setTimeout(
                function () {
                    remain -= timeLag;
                    $('#statusHolder').html(
                        '<center>\n' +
                        '                    <hr style="width: 90%;margin:20px 0 0 0;text-align: center">\n' +
                        '                    <div class="row">\n' +
                        '                        <h3 class="text-center"> 不在抢购时间段...</h3>\n' +
                        '                        <h4 class="text-center">倒计时：' + new Date(remain).format('hh小时mm分ss秒') + '</h4>\n' +
                        '                    </div>\n' +
                        '                </center>');
                    countdown(ele, startTime);
                }, 1000);
        }

    }

    function renderEnd(ele) {
        ele.html(
            '<center>\n' +
            '                    <hr style="width: 90%;margin:0 0;">\n' +
            '                    <div class="row">\n' +
            '                        <h3 class="text-center"> 抢购已经结束...</h3>\n' +
            '                    </div>\n' +
            '                </center>');
    }

    function renderSeckilling(ele) {
        ele.html(
            '<center>\n' +
            '                    <hr style="width: 90%;margin:0 0;">\n' +
            '                    <div class="row">\n' +
            '                        <h3 class="text-center"> 抢购正在进行中...</h3>\n' +
            '                        <a class="btn btn-success" href="#" onclick="confirmInformation()">立即抢购</a>\n' +
            '                    </div>\n' +
            '                </center>');
    }

    function doSeckill() {
        $.ajax({
            url: 'order/submit',
            method:'post',
            data: {
                userId:$('#userId').text(),
                goodsId:goodsId,
                addrId:$('input:radio:checked').val()
            },
            success:function (res) {
                if(res.code == 301){
                    // 如果进入了抢购队列
                    layer.msg('订单处理中...', {
                        time: 1000*3600
                    });
                    // 等待一秒钟再去查询结果
                    setTimeout(function(){
                            getMiaoshaResult();
                        }, 1000);
                }else{
                    // 如果没有库存或其他问题抢购失败
                    alert(res.msg);
                }
            }
        })
    }

    function confirmInformation() {
        if (!has) {
            has = true;
            var userId = $('#userId');
            if (userId.length == 0) {
                alert('请先登陆');
                return;
            }
            var goodsName = $('#name');
            $('#goodsName').text(goodsName.text());
            $.ajax({
                url: 'order/information?userId=' + userId.text(),
                success: function (res) {
                    var list = res.data;
                    var holder = $('#addrHolder');
                    if (list.length != 0) {
                        //循环渲染收货地址
                        for (x in list) {
                            if(x == 0){
                                holder.append('<div class="radio"  >\n' +
                                    '                                <label>\n' +
                                    '                                    <input type="radio" name="optionsRadios" id="optionsRadios1"  checked value='+list[x].id +'>'
                                    + list[x].phone + ',' + list[x].userName + '<br>' + list[x].addr +
                                    '                                </label>\n' +
                                    '                            </div>')
                            }else{
                                holder.append('<div class="radio"  >\n' +
                                    '                                <label>\n' +
                                    '                                    <input type="radio" name="optionsRadios" id="optionsRadios1" value='+list[x].id +'>'
                                    + list[x].phone + ',' + list[x].userName + '<br>' + list[x].addr +
                                    '                                </label>\n' +
                                    '                            </div>')
                            }
                        }
                    } else {
                        holder.append('<div class="alert alert-warning" role="alert">请先添加收货信息</div>')
                        $('#seckill').attr('disabled', 'disabled');
                    }
                }
            });
        }

        $('#InformationModal').modal({
            backdrop: "static"
        });
    }

    function getMiaoshaResult(){
        alert(goodsId);
        $.ajax({
            url:"order/result",
            type:"POST",
            data:{
                goodsId:goodsId,
                userId:$('#userId').text()
            },
            success:function(data){
                // 如果返回的代码是在队列中
                if(data.code == 302){
                    var result = data.data;
                    // 返回订单条数
                    if(result == 0){
                        layer.msg("对不起，抢购失败");
                    }
                    else{
                        layer.confirm("恭喜你，抢购成功！查看订单？", {btn:["确定","取消"]},
                            function(){
                                window.location.href="order/detail?orderId="+result;
                            },
                            function(){
                                layer.closeAll();
                            });
                    }
                }else{
                    layer.msg(data.msg);
                }
            },
            error:function(){
                layer.msg("客户端请求有误");
            }
        });
    }

</script>
</body>
</html>